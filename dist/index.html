<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./style.css" />
    <title>Koinos Contract</title>
  </head>

  <body>
    <div id="app">
      <div id="header">
        <h1>Contract</h1>
        <input
          type="text"
          v-model="inputContractId"
          placeholder="Contract ID"
        />
        <button @click="connectKondor()">Connect kondor</button>
      </div>
      <div class="container">
        <div class="menu">
          <div v-for="fn in contractFunctions" :key="fn.name">
            <button @click="openFunction(fn.name)">{{fn.prettyName}}</button>
          </div>
        </div>
        <div class="fn-data">
          <h2>{{contractFunction?.prettyName}}</h2>
          <div class="fn-description">{{contractFunction?.description}}</div>
          <proto-form
            v-if="contractFunction"
            :protobuftype="contractFunction.protobufType"
            :serializer="contract.serializer"
            reference="protoMessage"
            ref="protoMessage"
          ></proto-form>
          <button @click="callFunction()">Send</button>
        </div>
      </div>
    </div>
  </body>
  <script src="js/kondor.min.js"></script>
  <script src="js/koinos.min.js"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script type="module">
    import { ProtoForm, prettyName } from "./js/protoForm.js";

    const { createApp } = Vue;
    let defaultKoinosProvider = "https://api.koinos.io";
    const mkwWalletConnectorUrl =
      "https://mykw.vercel.app/embed/wallet-connector";
    let mkw;

    const app = createApp({
      data() {
        return {
          accounts: null,
          contract: null,
          contractFunction: null,
          contractFunctions: [],
          inputContractId: "",
          i: 0,
        };
      },

      watch: {
        inputContractId: function (val) {
          this.loadContract(val);
        },
      },

      mounted() {
        this.inputContractId = "1EwJUW4BFbA4EGmSyB9bgdhB3gk2f3shRN";
        // mkw = new MyKoinosWallet(mkwWalletConnectorUrl);
        // mkw.connect();
      },

      methods: {
        async connectKondor() {
          console.log("Connecting kondor...");
          this.accounts = await kondor.getAccounts();
          console.log("Kondor connected");
        },

        async loadContract(id) {
          //if (!this.accounts) await this.connectKondor();
          const provider = new Provider(["https://api.koinos.io"]);
          //const userAddress = this.accounts[0].address;

          this.contract = new Contract({
            id,
            provider,
            //signer: kondor.getSigner(userAddress),
          });
          await this.contract.fetchAbi();

          this.contractFunctions = Object.keys(this.contract.abi.methods).map(
            (name) => {
              const { argument } = this.contract.abi.methods[name];

              return {
                name,
                prettyName: prettyName(name),
                readOnly: this.contract.abi.methods[name].read_only,
              };
            },
          );
        },

        openFunction(name) {
          const { argument, description } = this.contract.abi.methods[name];
          const protobufType = argument
            ? this.contract.serializer.root.lookupType(argument)
            : undefined;

          this.contractFunction = {
            name,
            prettyName: prettyName(name),
            description,
            protobufType,
            readOnly: this.contract.abi.methods[name].read_only,
          };
        },

        callFunction() {
          const args = this.$refs.protoMessage.getArgs();
          console.log(this.contractFunction.name.toUpperCase());
          console.log(args);
        },
      },
    });

    app.component("ProtoForm", ProtoForm);

    app.mount("#app");
  </script>
</html>
